# ASM Test - 嵌入式操作系统实验项目

## 项目概述

ASM Test 是一个基于STM32F103C8T6微控制器的嵌入式操作系统实验项目，主要研究操作系统内核的基本功能实现，包括进程管理、内存管理和系统调用等。该项目旨在提供一个轻量级的实时操作系统(RTOS)框架，适合学习和研究嵌入式系统内核开发。

## 项目结构

```
asm_test/
├── Core/                    # 核心代码目录
│   ├── Inc/               # 头文件目录
│   ├── Kernal/            # 内核模块
│   │   ├── Inc/           # 内核头文件
│   │   │   ├── Kernal.h   # 内核主要功能定义
│   │   │   ├── common.h   # 通用数据类型和宏定义
│   │   │   ├── memory.h   # 内存管理模块定义
│   │   │   ├── process.h  # 进程管理模块定义
│   │   │   └── shell.h    # 命令行接口定义
│   │   └── Src/            # 内核源代码
│   │       ├── Kernal.c   # 内核主要功能实现
│   │       ├── common.c   # 通用函数实现
│   │       ├── memory.c   # 内存管理实现
│   │       ├── process.c  # 进程管理实现
│   │       └── shell.c    # 命令行接口实现
│   └── Src/                # 主程序源代码
├── Drivers/                # STM32 HAL驱动库
├── cmake/                  # CMake构建配置
├── CMakeLists.txt         # 项目构建主配置文件
└── README.md              # 项目说明文档
```

## 核心模块分析

### 1. 内核模块 (Kernal)

**功能**：操作系统的核心，负责系统初始化、进程调度、中断处理和系统调用管理。

**主要组件**：
- **系统初始化**：通过`kernal_boot()`函数启动内核，初始化必要的系统组件。
- **进程调度**：基于PendSV异常实现任务切换，使用`yield()`函数进行任务调度。
- **中断处理**：处理SVC系统调用和UsageFault异常。
- **系统调用**：提供内存分配和系统 panic 等系统调用功能。

**关键函数**：
- `kernal_boot()`: 内核启动函数，设置栈指针并跳转到内核主函数。
- `kernel_main()`: 内核主函数，初始化系统并启动调度器。
- `yield()`: 任务调度函数，选择下一个运行的任务。
- `PendSV_Handler()`: PendSV异常处理函数，实现任务上下文切换。

### 2. 进程管理模块 (process)

**功能**：管理系统中的进程，包括进程创建、状态管理和调度。

**主要组件**：
- **进程控制块(PCB)**：定义了进程的基本信息，包括PID、状态、栈指针等。
- **进程创建**：`create_process()`函数用于创建新进程，设置进程的初始栈帧。
- **进程调度**：基于简单的轮询调度算法，实现任务切换。

**关键数据结构**：
```c
typedef struct process {
    uint8_t pid;             // 进程 ID
    uint8_t state;           // 进程状态: PROC_UNUSED 或 PROC_RUNNABLE
    uint8_t first_in;
    vaddr_t sp;          // 栈指针，切换任务时记得将sp寄存器保存到这里
    uint32_t stack[64]; // 内核栈
}process_t;
```

**关键函数**：
- `create_process()`: 创建新进程，设置进程的初始栈帧和状态。
- `yield()`: 调度函数，选择下一个运行的任务。

### 3. 内存管理模块 (memory)

**功能**：管理系统内存，提供基本的内存分配功能。

**主要组件**：
- **页表管理**：使用简单的页表结构管理内存。
- **内存分配**：基于页的内存分配，每次分配一页内存(4KB)。

**关键函数**：
- `alloc_page()`: 分配指定数量的页内存。
- `get_free_RAM()`: 获取可用内存大小。

**关键数据结构**：
```c
typedef struct page_list{
    uint32_t start_addr;  // 内存起始地址
    uint32_t remain;    // 剩余内存大小
    uint32_t* page_ptr;  // 页指针
    struct page_list* next;  // 下一个页表
}page_list_t;
```

### 4. 通用模块 (common)

**功能**：提供系统通用的数据类型定义和基础函数。

**主要组件**：
- **数据类型定义**：定义了基本的整数类型和指针类型。
- **基础函数**：提供内存操作、字符串处理和格式化输出等基础功能。

**关键函数**：
- `ker_memset()`: 内存设置函数。
- `ker_memcpy()`: 内存拷贝函数。
- `ker_strcpy()`: 字符串拷贝函数。
- `ker_strcmp()`: 字符串比较函数。
- `ker_printf()`: 格式化输出函数。

## 系统架构

### 硬件平台
- 微控制器：STM32F103C8T6
- 主频：最高72MHz
- Flash：64KB
- RAM：20KB

### 软件架构
1. **硬件抽象层**：基于STM32 HAL库，提供硬件访问接口。
2. **内核层**：提供进程管理、内存管理和系统调用等核心功能。
3. **应用层**：用户应用程序，运行在内核之上。

### 中断处理
- **SVC中断**：处理系统调用。
- **PendSV中断**：用于任务上下文切换。
- **UsageFault中断**：处理使用错误，如除零错误。

## 开发环境

- **IDE**: 支持STM32CubeIDE、VSCode等
- **构建工具**: CMake 3.22+
- **编译器**: GCC ARM Embedded
- **调试工具**: ST-Link

## 构建与运行

### 构建步骤
1. 安装必要的开发工具链
2. 配置CMake构建环境
3. 执行构建命令生成可执行文件
4. 使用ST-Link将程序烧录到目标板

```bash
mkdir build
cd build
cmake ..
make
```

### 运行示例
项目包含基本的LED闪烁和ADC采样示例：
- LED每100ms闪烁一次
- 通过ADC采集传感器数据并通过UART输出

## 未来发展方向

1. 完善内存管理：实现更复杂的内存分配算法
2. 增强进程管理：添加进程间通信、信号量等功能
3. 添加文件系统：实现简单的文件系统
4. 扩展硬件支持：添加更多外设驱动
5. 优化调度算法：实现优先级调度和时间片轮转

## 作者信息

- 作者: qwqb233
- 邮箱: qwqb.zhang@gmail.com
- 日期: 2025-10-05

## 许可证

本项目遵循开源许可证，详见LICENSE文件。